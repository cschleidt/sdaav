<html>
    <head>
    
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>The bar in New York</title>
        
        <link rel="stylesheet" type="text/css" href="styles.css" />
        
        <style type="text/css">
            .categories-choropleth {
                fill: #ccc;
            }
            #tooltip-container {
                position: absolute;
                background-color: #fff;
                color: #000;
                padding: 10px;
                border: 1px solid;
                display: none;
                text-shadow:none;
            }
            .tooltip_key {
                font-weight: bold;
            }
            .tooltip_value {
                margin-left: 20px;
                float: right;
            }
            div.bar {
                display: inline-block;
                width: 20px;
                height: 75px;   /* We'll override height later */
                background-color: teal;
                margin-right: 10px;

            }
  
        </style>

        
    </head>
    
    <body>                        
        <div id="viz2" style="display: inline-block;"></div>
        <div id="viz" style="display: inline-block;"></div>
        <div id="tooltip-container"></div>


        
        <!-- JavaScript Includes -->
        
        <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.3.2/jquery.min.js"></script>
       <!-- <script src="jquery.scrollTo-1.4.2/jquery.scrollTo-min.js"></script> -->
        <script src="scripts/script.js"></script>
        <script type="text/javascript" src="//d3js.org/d3.v3.min.js"></script>





    </body>

<script>
    dataTable = {};
    zips = []
    //partyTable = {};
    getvizdata()

    function getvizdata()
        {
            d3.csv("zip_newdf_norm_w_cluster.csv", function(error, data) {

                 data.forEach(function(d) {
                    dataTable[String(parseInt(d.IncidentZip))] = [d.cluster,d.Niceness_norm,d.PartyBarComplaints];
                    zips.push(parseInt(d.IncidentZip));
                    //d.zip = d.IncidentZip;
                    //d.party = d.PartyBarComplains;
                    //d.niceness = d.Niceness;
                    //d.cluster = parseInt(d.cluster);
                 });
            });
        };
    var colors = d3.scale.category10();
    var w = 700, h = 600
    var projection = d3.geo.mercator()
        .center([-73.896522306614344, 40.754388796109033])
        .translate([w/2, h/2])
        .scale([65000]);
    var svg = d3.select("#viz")
        .append("svg")
        .attr("width", w)
        .attr("height", h);
    var colorScale = d3.scale.category20()

    var path = d3.geo.path()
            .projection(projection);
    d3.json("nyc.json", function(json) {
        svg.append("g")
            .attr("class", "categories-choropleth")
            .selectAll("path")
            .data(json.features)
            .enter()
            .append("path")
            .attr("d", path)
            .style("stroke-width", "1")
            .style("stroke", "black")
            //.style('fill-opacity', 0.3)
            .on("mouseover", function(d) {
                var html = "";
                html += "<div class='tooltip_kv'>";
                html += "<span class='tooltip_key'>";
                html += d.properties.borough;
                html += "</span>";
                html += "<span class='tooltip_value'>";
                html += d.properties.postalCode;
                html += "";
                html += "</span>";
                html += "</div>";
                html += "<div class='tooltip_kv'>";
                html += "<span class='tooltip_key'>";
                html += "Cluster";
                html += "</span>";
                html += "<span class='tooltip_value'>";
                if(zips.indexOf(parseInt(d.properties.postalCode)) != -1) {
                    html += dataTable[d.properties.postalCode][0];
                }
                else {
                    html += "Not available"
                }
                html += "";
                html += "</span>";
                html += "</div>";


                //}
                
                $("#tooltip-container").html(html);
                $(this).attr("fill-opacity", "0.8");
                $("#tooltip-container").show();
                
                var coordinates = d3.mouse(this);
                
                var map_width = $('.categories-choropleth')[0].getBoundingClientRect().width;
                
                if (d3.event.layerX < map_width / 2) {
                    d3.select("#tooltip-container")
                    .style("top", (d3.event.layerY + 15) + "px")
                    .style("left", (d3.event.layerX + 15) + "px");
                } else {
                    var tooltip_width = $("#tooltip-container").width();
                    d3.select("#tooltip-container")
                    .style("top", (d3.event.layerY + 15) + "px")
                    .style("left", (d3.event.layerX - tooltip_width - 30) + "px");
                }
                if(zips.indexOf(parseInt(d.properties.postalCode)) != -1) {
                    tmp = dataTable[d.properties.postalCode]
                    updateBars([tmp[1],tmp[2]]);
                }
            })
            .on("mouseout", function() {
                $(this).attr("fill-opacity", "1.0");
                $("#tooltip-container").hide();
            })
//            .text("district")
            .style("fill", function(d) {  
                if(zips.indexOf(parseInt(d.properties.postalCode)) != -1) {
                    return colorScale(parseInt(dataTable[d.properties.postalCode][0]));
                }
                return "white"
            });
    });

        
        var scale = d3.scale.linear()
                    .domain([0, 1])
                    .range([0, h]);

        var dataset = [0.6,0.90]
        var barPadding = 5

        var svgbar = d3.select("#viz2")
            .append("svg")
            .attr("width", w/9)
            .attr("height", h)
            .append("g")
            .attr("transform", 
                "translate(" + 10 + "," + 10 + ")");
/*
        var xAxi    s = d3.svg.axis()
            .orient("bottom")
            .ticks(["text1", "text2"]);
*/

        svgbar.selectAll("bar")
            .data(dataset)
            .enter()
            .append("rect")
            .style("fill", "blue")
            .attr("x", function(d, i) {
                return i * ((w/10) / dataset.length); 
                })
            .attr("width", (w/15) / dataset.length - barPadding)
            .attr("y", function(d) { return h - scale(d); 
                })
            .attr("height", function(d) { 
                var barHeight = d;
                return scale(barHeight);
             })
             .style("stroke-width", "1")
             .style("stroke", "black");

        svgbar.selectAll("text")
            .data(dataset)
            .enter()
            .append("text")
            .attr("x", function(d, i) {
                return i * ((w/10) / dataset.length);
            })
            .attr("y", function(d) {
                return h - scale(d);
            })
            .text(function(d) { return d; });


    function updateBars(dataSet) {
        console.log(dataSet);

        svgbar.selectAll("rect")
            .data(dataSet)
            .transition()
            .duration(100)
            .attr("height", function(d) {
                var barHeight = d;  //Scale up by factor of 5
                console.log(barHeight);
                return scale(barHeight);
            })
            .attr("y", function(d) {
                 return h - scale(d);  //Height minus data value
            })
            //.attr("width", (w) / dataSet.length - barPadding)
            ;

        svgbar.selectAll("text")
            .data(dataSet)
            .transition()
            .duration(100)
            .text(function(d) { return d; })
            /*
            .attr("x", function(d, i) {
                return i * ((w/10) / dataset.length);
            })
            */
            .attr("y", function(d) {
                return h - scale(d);
            })
            
            ;
    }
</script>
</html>
